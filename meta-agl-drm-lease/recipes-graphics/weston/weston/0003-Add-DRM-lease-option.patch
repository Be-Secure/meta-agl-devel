From f9beb0102c308a952b37559ef4ce6d25f4f68e51 Mon Sep 17 00:00:00 2001
From: Damian Hobson-Garcia <dhobsong@igel.co.jp>
Date: Tue, 2 Feb 2021 16:07:09 +0900
Subject: [PATCH 3/3] Add DRM lease option

Add command line option to use a DRM lease instead of a primary node for
output when using the DRM backend.
---
 compositor/main.c               | 5 +++++
 include/libweston/backend-drm.h | 3 +++
 libweston/backend-drm/drm.c     | 4 ++++
 3 files changed, 12 insertions(+)

diff --git a/compositor/main.c b/compositor/main.c
index 8eb8a470..0b374710 100644
--- a/compositor/main.c
+++ b/compositor/main.c
@@ -669,6 +669,9 @@ usage(int error_code)
 		"  --seat=SEAT\t\tThe seat that weston should run on, instead of the seat defined in XDG_SEAT\n"
 		"  --tty=TTY\t\tThe tty to use\n"
 		"  --drm-device=CARD\tThe DRM device to use, e.g. \"card0\".\n"
+#ifdef BUILD_DRM_LEASE_CLIENT
+		"  --drm-lease=lease\tUse the specified DRM lease. e.g \"card0-HDMI-A-1\"\n"
+#endif
 		"  --use-pixman\t\tUse the pixman (CPU) renderer\n"
 		"  --current-mode\tPrefer current KMS mode over EDID preferred mode\n\n");
 #endif
@@ -2492,6 +2495,7 @@ load_drm_backend(struct weston_compositor *c,
 		{ WESTON_OPTION_STRING, "seat", 0, &config.seat_id },
 		{ WESTON_OPTION_INTEGER, "tty", 0, &config.tty },
 		{ WESTON_OPTION_STRING, "drm-device", 0, &config.specific_device },
+		{ WESTON_OPTION_STRING, "drm-lease", 0, &config.drm_lease_name },
 		{ WESTON_OPTION_BOOLEAN, "current-mode", 0, &wet->drm_use_current_mode },
 		{ WESTON_OPTION_BOOLEAN, "use-pixman", 0, &config.use_pixman },
 	};
@@ -2526,6 +2530,7 @@ load_drm_backend(struct weston_compositor *c,
 
 	free(config.gbm_format);
 	free(config.seat_id);
+	free(config.drm_lease_name);
 
 	return ret;
 }
diff --git a/include/libweston/backend-drm.h b/include/libweston/backend-drm.h
index f6647e28..309ea618 100644
--- a/include/libweston/backend-drm.h
+++ b/include/libweston/backend-drm.h
@@ -223,6 +223,9 @@ struct weston_drm_backend_config {
 
 	/** Use shadow buffer if using Pixman-renderer. */
 	bool use_pixman_shadow;
+
+	/** DRM lease name */
+	char *drm_lease_name;
 };
 
 #ifdef  __cplusplus
diff --git a/libweston/backend-drm/drm.c b/libweston/backend-drm/drm.c
index 6fe01aa0..7e566641 100644
--- a/libweston/backend-drm/drm.c
+++ b/libweston/backend-drm/drm.c
@@ -2897,6 +2897,10 @@ drm_backend_create(struct weston_compositor *compositor,
 
 	if (config->specific_device)
 		drm_device = open_specific_drm_device(b, config->specific_device);
+#ifdef BUILD_DRM_LEASE_CLIENT
+	else if (config->drm_lease_name)
+		drm_device = open_launcher_drm_device(b, config->drm_lease_name);
+#endif
 	else
 		drm_device = find_primary_gpu(b, seat_id);
 	if (drm_device == NULL) {
-- 
2.25.1

